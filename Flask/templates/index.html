<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <title>Pen Plotter Control Page</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        /*
        :root {
            --background-col: #353535;
            --ds-col: #BABABA; 
        }
        
        #container {  
            position: absolute;
            background-color: var(--ds-col);
            align-items: center;
            justify-content: center;
            width: 1280px;
            height: 640px;
            border-radius: 640px 640px 4px 4px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            touch-action: none;    
        }

        #item {
            width: 20px;
            height: 20px;
            background-color: rgb(0,0,255);  
            border: 5px solid rgba(100, 100, 200, .5);
            border-radius: 50%;
            touch-action: none;
            user-select: none;
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -10px 0 0 -10px;  
        }

        #item:active {
            background-color: rgba(168, 218, 220, 1.00);
        }

        #item:hover {
            cursor: pointer;
            border-width: 5px;
        }

        body {
            background: var(--background-col);
        }

        .info {
            color: var(--ds-col);
            font-size: 10px;
            left: 0;  
        }

        .paint {
            width: 15px;
            height: 15px;
            background-color: rgb(255,0,0);
            border-radius: 50%;
            position: absolute;
        }

        .hbtn, .dbtn, .rbtn {
            height: 60px;
            width: 130px;
            display: block;
            border-radius: 4px;
            font-size: 30px;
            border: 2px solid #1E1E1E;
            transition-time: 0.2s;
        }
        
        .dbtn {
            background-color: #62AD54;
        }

        .dbtn:hover {
            background-color: #457A3B;
        }

        .hbtn {
            background-color: #3D8cB9;
        }

        .hbtn:hover {
            background-color: #2C6585;
        }

        .rbtn {
            background-color: #E34B3B;
        }
        
        .rbtn:hover {
            background-color: #B03A2D;
        }
        */
    </style>
</head>

<body>
    
    <div id="outerContainer">
        <div id="container">
            <div id="item"></div>
        </div>
    </div>
        
    <form method="post" action="{{ url_for('checkButtons') }}">
        <input id="dbtn" class="dbtn" type="submit" value="Draw" name="drawbtn"/>
        <input id="hbtn" class="hbtn" type="submit" value="Home" name="homebtn"/>
        <input id="rbtn" class="rbtn" type="submit" value="Reset" name="resetbtn"/>
    </form>
 
    <p class="info">Current position: <span id="xpos"></span>, <span id="ypos"></span></p>
    <p class="info">User drawing: <span id="udrawing"></span></p> 

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="{{url_for('static', filename='jquery.js')}}">\x3C/script>')</script>
    {{ JSGlue.include() }}

    <script>
        var dragItem = document.querySelector("#item");
        var container = document.querySelector("#container");

        var active = false;
        var currentX;
        var currentY;
        var initialX;
        var initialY;
        var xOffset = 0;
        var yOffset = 0;

        var yLimit = 0;
        var xLimit = 0;

        var initial = Date.now()
        var current = 0;

        var divArray = [];
        var divNum = 0;

        let spacebarPressed = false;
        
        let rawPath = [];
        let path = [];

        var firstRun = true;

        container.addEventListener("touchstart", dragStart, false);
        container.addEventListener("touchend", dragEnd, false);
        container.addEventListener("touchmove", drag, false);

        container.addEventListener("mousedown", dragStart, false);
        container.addEventListener("mouseup", dragEnd, false);
        container.addEventListener("mousemove", drag, false);

        document.addEventListener("keydown", event => {
            if(event.code === 'Space'){
                spacebarPressed = true;
            }
        });
        document.addEventListener("keyup", event => {
            if(event.code === 'Space'){
                spacebarPressed = false;
            }
        });

      
        function dragStart(e){
            if(e.type === "touchstart"){
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            }else{
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }
            if(e.target === dragItem){
                active = true;
            }
        }

        function dragEnd(e){
            initialX = currentX;
            initialY = currentY;
            active = false;
        }

        function drag(e){
            if(active){
                current = Date.now();
                e.preventDefault();

                if(e.type === "touchmove"){
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                }else{
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }

                xOffset = currentX;
                yOffset = currentY;

                var pos = convertPos(currentX, currentY);
                var x = pos[0];
                var y = pos[1];

                if((current - initial) > 5){
                    if(spacebarPressed){
                        if(firstRun == true){
                            penUpDown('down');
                            firstRun = false;
                        }
                        path.push([0, 0]);
                        sendPosition(x, y);
                        createDiv(currentX, currentY);
                        collectPos(currentX, currentY, x, y)
                        storeData();
                    }else{
                        if(firstRun == false){
                            penUpDown('up');
                            firstRun = true;
                        }
                    } 
                    initial = Date.now();
                }
  
                document.getElementById("xpos").innerHTML = x; 
                document.getElementById("ypos").innerHTML = y; 
                document.getElementById("udrawing").innerHTML = spacebarPressed;
                setTranslate(currentX, currentY, dragItem);
            }
        }

        document.getElementById('dbtn').onclick = () => {
            sessionStorage.setItem('reloading', 'true')
            sessionStorage.setItem('regenDivs', 'true');
        }
        document.getElementById('rbtn').onclick = () => {
            sessionStorage.setItem('reloading', 'true');
            sessionStorage.setItem('resetPath', 'true');
        }
        
        document.getElementById('hbtn').onclick = () => {
            sessionStorage.setItem('reloading', 'true');
            sessionStorage.setItem('regenDivs', 'true');
        }
        

        $(document).ready(function() {
            console.log("page loaded");
            var reloading = sessionStorage.getItem("reloading");
            console.log(sessionStorage.getItem("regenDivs"), sessionStorage.getItem("resetPath"));
            if(reloading){
                sessionStorage.removeItem("reloading");
                if(sessionStorage.getItem("regenDivs") == 'true'){
                    regenDivs();
                    sessionStorage.removeItem("regenDivs");
                }
                if(sessionStorage.getItem("resetPath") == 'true'){
                    resetPath();
                    sessionStorage.removeItem("resetPath");
                }
            }

        });

        document.body.onload = createDiv;
        let containerDiv = document.getElementById("item");
        let parentDiv = containerDiv.parentNode;

        function createDiv(cX, cY){
            divArray[divNum] = document.createElement("div" + divNum);
            divArray[divNum].className = 'paint';
            parentDiv.insertBefore(divArray[divNum], containerDiv);

            const d = document.getElementsByTagName("div" + divNum)[0];
            d.style.top = cY + 320 + "px";
            d.style.left = cX + 640 + "px";
            
            divNum++;
        }

        function regenDivs(){
            console.log("starting regen");
            var storedPath = JSON.parse(sessionStorage.getItem("path"));
            var storedRawPath = JSON.parse(sessionStorage.getItem("rawPath"));
    
            if(storedRawPath == null){
                console.log("path null");
                storedRawPath = [[0, 160]];
                return 0;
            }else{
                console.log(storedRawPath.toString());
            }

            for(let i = 0; i < storedRawPath.length; i++){
                createDiv(storedRawPath[i][0], storedRawPath[i][1]);
                console.log("Created div at: " + storedRawPath[i][0] + ", " + storedRawPath[i][1]);
            }
             
            path = storedPath;
            rawPath = storedRawPath;

        }

        function resetPath(){
            clearDivs();
            sessionStorage.removeItem("rawPath");
            sessionStorage.removeItem("path");
            sessionStorage.removeItem("numDivs");
            path = [];
            rawPath = [];
            divArray = [];
            numDivs = 0;
        }

        function clearDivs(){
            for(let i = 0; i < parseInt(sessionStorage.getItem("numDivs")); i++){
                try{
                    var el = document.getElementsByTagName("div" + i)[0];
                    el.remove();
                    console.log("removed div" + i);
                }catch(err){
                    console.log("error on div" + i + ", continuing");
                }
            }
        } 

        function penUpDown(state){
            if(state == 'down'){
                sendPosition('pen_down', 'pen_down');
            }else{
                sendPosition('pen_up', 'pen_up');
            }
        }       

        function storeData(){
            if(typeof(Storage) !== "undefined"){
                sessionStorage.setItem("path", JSON.stringify(path));
                sessionStorage.setItem("rawPath", JSON.stringify(rawPath));
                sessionStorage.setItem("numDivs", divNum);
            }else{
                console.log("error");
            }
        }

        function collectPos(rcX, rcY, cX, cY){
            rawPath.push([rcX, rcY]);
            path.push([cX, cY]);
        }

        function sendPosition(cX, cY){
            var position = {
                'x': cX,
                'y': cY            
            }
            $.ajax({
            url: Flask.url_for('getPosition'),
            type: 'POST',
            data: JSON.stringify(position),
            dataType: "json",
            contentType: "application/json",
            success: function(response){
                console.log(response);
            },
            error: function(err){
                console.log(err);
            }
            });
        }

        function convertPos(cX, cY){
            return [Math.round(cX / 2), Math.round((cY * -1 + 320) / 2)];
        }

        function setTranslate(xPos, yPos, el){
            el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
        }
        
    </script>
</body>

</html>
